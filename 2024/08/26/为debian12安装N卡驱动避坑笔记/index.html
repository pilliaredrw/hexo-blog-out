<!DOCTYPE html>
<html 
	lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		
<link rel="stylesheet" href="/css/layout.css">

		
		<title> 为debian12安装N卡驱动避坑笔记 -  走线联络站</title>
		<!-- <link rel="stylesheet" href="https://unpkg.com/mdui@1.0.2/dist/css/mdui.min.css" /> -->
		<!-- <script src="https://unpkg.com/mdui@1.0.2/dist/js/mdui.min.js"></script> -->
		
<link rel="stylesheet" href="/lib/mdui/mdui.min.css">

		
<script src="/lib/mdui/mdui.min.js"></script>

		<!-- lazyload -->
		
<script src="/lib/lazysizes.js"></script>

		<!-- smooth-scrolling -->
		
<script src="/lib/smooth-scrolling.js"></script>

		<!-- highlight -->
		
<link rel="stylesheet" href="/lib/highlight/atom-one-dark.min.css">

		
<script src="/lib/highlight/highlight.min.js"></script>

		<!-- 预置 kiraicon -->
		
<link rel="stylesheet" href="/lib/iconfont/iconfont.css">

		
			<link rel="stylesheet" href="/assets/font_ext/iconfont.css" crossorigin />
		
		<link
			rel="shortcut icon"
			href="/assets/pics/ico.jpg"
			type="image/png"
		/>
		
<link rel="stylesheet" href="/deps/css/APlayer.min.css">

		
		
<script src="/deps/js/APlayer.min.js"></script>
<script src="/deps/js/Meting.min.js"></script>

	<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

	<body>
		<div
			class="kira-background"
			style="background-image: url('/assets/pics/bg3.jpg')"
		></div>
		<div class="kira-header">
    <a
        class="kira-drawer-button mdui-ripple"
        title="导航栏"
        onclick="document.querySelector('.kira-sidebar-modal').classList.add('show');document.querySelector('.kira-sidebar#sidebar').classList.add('show');"
    >
        <i class="kirafont icon-menu"></i>
    </a>
    <a href="/" title="走线联络站">
        <img
			src="https://kosuzu.baby/file/users/1/avatar"
			alt="Pilliaredrw"
		/>
    </a>
</div>
		<div class="kira-body">
			<div class="kira-sidebar" id="sidebar">
	<div class="kira-avatar mdui-ripple">
		<a target="_blank" rel="noopener" href="https://kosuzu.baby/file/users/1/avatar" title="Pilliaredrw">
			<img
				src="https://kosuzu.baby/file/users/1/avatar"
				alt="Pilliaredrw"
			/>
		</a>
	</div>
	<div class="kira-count">
		<div><span>文章</span>7</div>
		<div><span>标签</span>7</div>
		<div><span>分类</span>0</div>
	</div>
	<div class="kira-list">
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/"
			title="联络站首页"
		>
			<i
				class="kirafont
					
						icon-home
					"
			></i>
			<div class="kira-list-item-content">
				联络站首页
			</div>
		</a>
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/archive.html"
			title="文章归档"
		>
			<i
				class="kirafont
					
						icon-container
					"
			></i>
			<div class="kira-list-item-content">
				文章归档
			</div>
		</a>
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/about.html"
			title="关于本人"
		>
			<i
				class="kirafont
					
						icon-user
					"
			></i>
			<div class="kira-list-item-content">
				关于本人
			</div>
		</a>
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/friends.html"
			title="我的朋友"
		>
			<i
				class="kirafont
					
						icon-team
					"
			></i>
			<div class="kira-list-item-content">
				我的朋友
			</div>
		</a>
		
	</div>
	<aside id="kira-sidebar">
		
			<div class="kira-widget-wrap">
	<div class="kira-widget kira-social">
		
			<a
				class="mdui-ripple"
				href="https://space.bilibili.com/1649952188"
				target="_blank"
				mdui-tooltip="{content: '哔哩哔哩'}"
				style="color: rgb(231, 106, 141); background-color: rgba(231, 106, 141, .15);"
			>
				<i
					class="kirafont
					
						icon-bilibili
					"
				></i>
			</a>
		
			<a
				class="mdui-ripple"
				href="https://x.com/pilliaredrw"
				target="_blank"
				mdui-tooltip="{content: 'Twitter'}"
				style="color: rgb(49, 174, 255); background-color: rgba(49, 174, 255, .1);"
			>
				<i
					class="kirafont
					
						icon-twitter
					"
				></i>
			</a>
		
			<a
				class="mdui-ripple"
				href="https://t.me/tsu_zu"
				target="_blank"
				mdui-tooltip="{content: 'Telegram'}"
				style="color: rgb(49, 174, 255); background-color: rgba(49, 174, 255, .15);"
			>
				<i
					class="kirafont
					
						icon-telegram
					"
				></i>
			</a>
		
			<a
				class="mdui-ripple"
				href="https://github.com/pilliaredrw/"
				target="_blank"
				mdui-tooltip="{content: 'GitHub'}"
				style="color: rgb(25, 23, 23); background-color: rgba(25, 23, 23, .15);"
			>
				<i
					class="kirafont
					
						icon-github
					"
				></i>
			</a>
		
			<a
				class="mdui-ripple"
				href="https://tieba.baidu.com/home/main?id=tb.1.9e11ebcf.yJMbYDjnTkgZAgeTczkWyg"
				target="_blank"
				mdui-tooltip="{content: '百度贴吧'}"
				style="color: rgb(49, 174, 255); background-color: rgba(49, 174, 255, .15);"
			>
				<i
					class="kirafont
					
						icon-tieba
					"
				></i>
			</a>
		
			<a
				class="mdui-ripple"
				href="https://www.pixiv.net/users/33323127"
				target="_blank"
				mdui-tooltip="{content: 'Pixiv'}"
				style="color: rgb(0, 150, 250); background-color: rgba(0, 150, 250, .15);"
			>
				<i
					class="kirafont
					
						icon-pixiv
					"
				></i>
			</a>
		
	</div>
</div>

		
			
		
			
	<div class="kira-widget-wrap">
		<div id="randomtagcloud" class="kira-widget tagcloud kira-rainbow">
			<a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">C语言</a> <a href="/tags/Debian/" style="font-size: 10px;">Debian</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 20px;">二叉树</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 20px;">数据结构</a> <a href="/tags/%E7%8E%A9%E7%94%B5%E8%84%91/" style="font-size: 15px;">玩电脑</a>
		</div>
		
	</div>


		
			
	<div class="kira-widget-wrap">
		<h3 class="kira-widget-title">
			文章归档
		</h3>
		<div class="kira-widget">
			<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">7</span></li></ul>
		</div>
	</div>


		
	</aside>
	<div class="kira-copyright">
		&copy; 2024
		<a href="/">Pilliaredrw</a>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> &
		<a href="https://github.com/ch1ny/kira-hexo/" target="_blank">Kira-Hexo</a>
		<br />
		
		
	</div>
</div>
<div
	class="kira-sidebar-modal"
	id="sidebar-modal"
	onclick="(function(self) {
		self.classList.remove('show');
		document.querySelector('.kira-sidebar.show#sidebar').classList.remove('show');
	})(this)"
></div>
			<div class="kira-content">
				<div id="kira-top-header"></div>
				<div class="kira-main-content">
					
<link rel="stylesheet" href="/css/kira-image.css">


<script src="/js/kira-image.js"></script>

<div class="kira-image">
    <div class="kira-image-modal">
        <div class="kira-image-header">
            <div class="kira-image-counter"></div>
            <div class="kira-image-title"></div>
            <div class="kira-image-operation">
                <div class="kira-image-operation-button" id="kira-image-operation-button-zoom">
                    <i class="kirafont icon-zoom-in"></i>
                </div>
                <div class="kira-image-operation-button" id="kira-image-operation-button-close">
                    <i class="kirafont icon-close"></i>
                </div>
            </div>
        </div>
        <div class="kira-image-container">
            <div class="kira-image-prev-button-panel">
                <div class="kira-image-exchange-button">
                    <i class="kirafont icon-left"></i>
                </div>
            </div>
            <div class="kira-image-list">
                <div class="kira-image-prev">
                    <img />
                </div>
                <div class="kira-image-now">
                    <img />
                </div>
                <div class="kira-image-next">
                    <img />
                </div>
            </div>
            <div class="kira-image-next-button-panel">
                <div class="kira-image-exchange-button">
                    <i class="kirafont icon-right"></i>
                </div>
            </div>
        </div>
    </div>
</div>

	
<link rel="stylesheet" href="/css/kira-code-copy.css">

	
<script src="/js/kira-code-copy.js"></script>


<div class="kira-post">
	<article>
		
		<div class="kira-post-cover">
			<img
				data-src="https://s2.loli.net/2024/08/26/kuzESBedjvZwHMf.png"
				data-sizes="auto"
				alt="为debian12安装N卡驱动避坑笔记"
				class="lazyload kira-post-cover-image disabled-kira-image"
			/>
			<h1>为debian12安装N卡驱动避坑笔记</h1>
		</div>
		
		<div class="kira-post-meta kira-rainbow" style="margin:10px 0!important;">
			<a><i class="kirafont icon-calendar-fill"></i>2024年08月26日</a>
			<a><i class="kirafont icon-edit-fill"></i>2.6k 字</a>
			<a><i class="kirafont icon-time-circle-fill"></i>大概 11 分钟</a>
		</div>
		<p>改用linux系统后,最大的问题莫过于闭源的N卡驱动不兼容所带来的一系列问题.
然后我的桌面环境还是wayland, 更添加了一笔不稳定性. 为了别累着集显,
这个问题还是要解决一下的.</p>
<h2><span id="我的系统配置">我的系统配置</span></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>Operating System: Debian GNU/Linux 12<br>KDE Plasma Version: 5.27.5<br>KDE Frameworks Version: 5.103.0<br>Qt Version: 5.15.8<br>Kernel Version: 6.1.0-23-amd64 (64-bit)<br>Graphics Platform: Wayland<br>Processors: 12 × 11th Gen Intel® Core™ i5-11400H @ 2.70GHz<br>Memory: 15.4 GiB of RAM<br>Graphics Processor: Mesa Intel® UHD Graphics<br>Manufacturer: Acer<br>Product Name: Nitro AN515-57<br>System Version: V1.17<br><br></code></pre></td></tr></table></figure>
<h2><span id="在系统初装时要解决的问题">在系统初装时要解决的问题</span></h2>
<h3><span id="添加sudoers">添加sudoers</span></h3>
<p>进入<code>/etc/sudoers</code>中, 仿照root的权限来添加自己的账户.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># User privilege specification</span><br>root ALL=(ALL:ALL) ALL<br>&lt;用户名&gt; ALL=(ALL:ALL) ALL<br></code></pre></td></tr></table></figure>
<h3><span id="添加非free源">添加非free源</span></h3>
<p>将<code>deb http://deb.debian.org/debian/ bookworm main contrib non-free non-free-firmware</code>添加到<code>/etc/apt/sources.list</code>中.</p>
<ul>
<li><strong><code>main</code></strong>: 完全自由的软件包,符合 Debian
自由软件指导原则.</li>
<li><strong><code>contrib</code></strong>:
自由软件包,但依赖非自由软件.</li>
<li><strong><code>non-free</code></strong>: 非自由软件包,不符合 Debian
自由软件指导原则.</li>
<li><strong><code>non-free-firmware</code></strong>:
非自由的硬件固件包.</li>
</ul>
<h3><span id="安装内核头文件坑">安装内核头文件(坑)</span></h3>
<p>将内核头文件补全, 防止驱动安装失败或不完整.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install linux-headers-$(<span class="hljs-built_in">uname</span> -r)<br></code></pre></td></tr></table></figure>
<h2><span id="检查本地显卡属性安装前准备">检查本地显卡属性(安装前准备)</span></h2>
<h3><span id="查看显卡型号">查看显卡型号</span></h3>
<p>使用<code>lspci -nn | egrep -i "3d|display|vga"</code>来查看本机的显卡型号.
这句话的含义是列出所有挂在pci总线上的设备,
然后筛选出来含有3d之类字样的设备(也就是显卡).</p>
<p>在这里我的输出如下, 可以看到集显,
独显和一个不知道为什么会在这里的sata控制器, 不用管它.
在这里证明了机身上确实是连接着显卡的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">0000:00:02.0 VGA compatible controller [0300]: Intel Corporation TigerLake-H GT1 [UHD Graphics] [8086:9a68] (rev 01)<br>0000:01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GA106M [GeForce RTX 3060 Mobile / Max-Q] [10de:2520] (rev a1)<br>10000:e0:17.0 SATA controller [0106]: Intel Corporation Tiger Lake SATA AHCI Controller [8086:43d3] (rev 11)<br></code></pre></td></tr></table></figure>
<h3><span id="使用nvidia-detect检查所需安装的版本">使用nvidia-detect检查所需安装的版本</span></h3>
<p>使用<code>sudo apt update &amp;&amp; sudo apt-get install nvidia-detect &amp;&amp; nvidia-detect</code>来直接查看输出.</p>
<p>可以看到我的输出如下所示.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">Detected NVIDIA GPUs:<br>0000:01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GA106M [GeForce RTX 3060 Mobile / Max-Q] [10de:2520] (rev a1)<br><br>Checking card: 00.0 VGA compatible controller<br>Your card is supported by all driver versions.<br>Your card is also supported by the Tesla 470 drivers series.<br>It is recommended to install the<br>    nvidia-driver<br>package.<br></code></pre></td></tr></table></figure>
<p>我们只需要看它推荐安装的驱动包名就好了,
这里推荐的是<code>nvidia-driver</code>. 于是接下来选择安装它.</p>
<h2><span id="安装驱动">安装驱动</span></h2>
<h3><span id="1检查biosuefi设置是否为安全启动坑">1.
检查BIOS/UEFI设置是否为安全启动(坑)</span></h3>
<p><strong>概括: 关闭安全启动.</strong></p>
<p>在部分主板中(比如宏碁暗影骑士擎的阉割bios), 安全启动是默认勾选的.
这会阻碍启动内核时n卡驱动的正常加载. 详情可参考 wiki 对这一点的讲解<a target="_blank" rel="noopener" href="https://wiki.debian.org/SecureBoot#DKMS_and_secure_boot">SecureBoot</a>.</p>
<p>简单来说, 就是某些 bios 会要求系统启动时验证系统的完整性.
而n卡驱动由于其闭源的特性, 没有集成在内核中(废话,
要不然也不用自己手动装了), 只能通过 DKMS(动态内核模块系统) 来和内核通讯.
这时候如果驱动模块没有被签名, bios 就会拒绝将其加载,
进而导致两种可能的情况: 一, 模块加载但系统进入之后就被卸载; 二,
模块无法加载, 只能进入 tty2 卸载驱动. 两种情况都无法使显卡生效.
而手动为其签名相对复杂, 且可能导致第二种情况,
相比简单关闭安全启动来说有些得不偿失.
因此在这里我选择了关闭安全启动.(其实是没搞清楚 mokutil
到底怎么用..)如果实在有需要, 在这里可以参考这些资料:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.debian.org/SecureBoot#DKMS_and_secure_boot" class="uri">https://wiki.debian.org/SecureBoot#DKMS_and_secure_boot</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yutian-blogs/p/13019226.html" class="uri">https://www.cnblogs.com/yutian-blogs/p/13019226.html</a></li>
<li><a target="_blank" rel="noopener" href="https://forums.linuxmint.com/viewtopic.php?t=376059" class="uri">https://forums.linuxmint.com/viewtopic.php?t=376059</a></li>
<li><a target="_blank" rel="noopener" href="https://tigress.cc/2023/09/18/Debian-Nvidia/" class="uri">https://tigress.cc/2023/09/18/Debian-Nvidia/</a></li>
</ul>
<h3><span id="2-安装驱动">2. 安装驱动</span></h3>
<p>假设nvidia-detect提示建议安装<code>nvidia-driver</code>,
那么直接安装以下包(否则替换):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># apt update</span><br><span class="hljs-comment"># apt install nvidia-driver firmware-misc-nonfree nvidia-smi</span><br></code></pre></td></tr></table></figure>
<p>在此之后, DKMS将通过 nvidia-kernel-dkms 软件包自动构建 nvidia
模块(如果前面没有补全头文件这里就会炸).
同时这也就是关闭安全启动的原因.</p>
<h2><span id="检查驱动安装情况以及打开">检查驱动安装情况以及打开</span></h2>
<p>为了确保N卡驱动能在 Plasma wayland 上正常使用, 还需要一些额外的配置.
这里参考 Plasma 社区所给的教程: <a target="_blank" rel="noopener" href="https://community.kde.org/Plasma/Wayland/Nvidia" class="uri">https://community.kde.org/Plasma/Wayland/Nvidia</a></p>
<h3><span id="1-首先满足以下前提条件">1. 首先满足以下前提条件</span></h3>
<ol type="1">
<li><strong>Plasma 版本</strong>:确保使用 Plasma 5.20.2 及以上.</li>
<li><strong>NVIDIA 驱动程序</strong>:确保 NVIDIA 驱动程序不低于 495.44
版本, KWin 不再与早期版本兼容.</li>
<li><strong>Qt 版本</strong>:确保使用最新版本的 Qt,至少需要 Qt5.15.0
或包含补丁的版本.</li>
<li><strong>Nvidia EGL 库</strong>:确保已安装 Nvidia EGL 库,例如在
Ubuntu 和 Neon 系统中,相关的包名为
<code>libnvidia-egl-wayland1</code>.</li>
</ol>
<p>而要在 Wayland 会话中启用 XWayland
应用的硬件加速,还需满足以下条件:</p>
<ol type="1">
<li><strong>Xorg 版本</strong>:需要 Xorg 1.20.12 或更高版本.</li>
<li><strong>XWayland 版本</strong>:需要 XWayland 21.1.2 或更高版本.</li>
<li><strong>libxcb 版本</strong>:需要 libxcb 1.1.7 或更高版本.</li>
</ol>
<h3><span id="2-检查驱动安装情况">2. 检查驱动安装情况</span></h3>
<ul>
<li>正常情况下, 使用 nvidia-smi 指令可以获取到一张显示显卡情况的表格.
例如这样:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">Mon Aug 26 18:49:41 2024<br>+---------------------------------------------------------------------------------------+<br>| NVIDIA-SMI 535.183.01             Driver Version: 535.183.01   CUDA Version: 12.2     |<br>|-----------------------------------------+----------------------+----------------------+<br>| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |<br>| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |<br>|                                         |                      |               MIG M. |<br>|=========================================+======================+======================|<br>|   0  NVIDIA GeForce RTX 3060 ...    On  | 00000000:01:00.0 Off |                  N/A |<br>| N/A   54C    P8              12W /  80W |      8MiB /  6144MiB |      0%      Default |<br>|                                         |                      |                  N/A |<br>+-----------------------------------------+----------------------+----------------------+<br><br>+---------------------------------------------------------------------------------------+<br>| Processes:                                                                            |<br>|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |<br>|        ID   ID                                                             Usage      |<br>|=======================================================================================|<br>|    0   N/A  N/A      1343      G   /usr/lib/xorg/Xorg                            4MiB |<br>+---------------------------------------------------------------------------------------+<br><br></code></pre></td></tr></table></figure>
<ul>
<li>但如果提示如下信息,
那么就需要考虑是否是签名问题或其他原因(比如安装了错误的版本).
如果不幸的进入了这种情况, 那么在这里可以参考<a target="_blank" rel="noopener" href="https://forums.debian.net/viewtopic.php?t=155273" class="uri">https://forums.debian.net/viewtopic.php?t=155273</a>,
以及使用<code>sudo dmesg | grep nvidia</code>或<code>sudo journalctl -xe | grep nvidia</code>或<code>lsmod | grep nvidia</code>来找出原因.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">NVIDIA-SMI has failed because it couldn<span class="hljs-string">'t communicate with the NVIDIA driver. Make sure that the latest NVIDIA driver is installed and running</span><br></code></pre></td></tr></table></figure>
<h3><span id="3-检查显卡工作情况">3. 检查显卡工作情况</span></h3>
<p><code>sudo apt install nvtop &amp;&amp; glmark2</code>先安装一个直观的集显&amp;独显的观察工具
nvtop 来观察两个显卡的状态.(防止只调集显的情况发生).
而在这里测试工具我选择了 glmark2. 不过也可以选择类似于 <a target="_blank" rel="noopener" href="https://geeks3d.com/furmark/downloads/">FurMark</a> 之类的来,
效果都一样, 只不过甜甜圈提供的选项要更多(可以分别测试 OpenGL 和 Vulkan).
<em>(PS: 悲伤的, 在这个过程中我发现了我目前OpenGL测试会调不动独显,
不知道为什么. 而Vulkan是正常的)</em></p>
<p>如下图所示, 在本机上测试为独显和集显都有运行, 这样是正常的.
如果只有集显工作, 那么尝试下面的步骤.</p>
<figure>
<img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2024/08/26/kuzESBedjvZwHMf.png" alt="正常情况" class="lazyload">
<figcaption aria-hidden="true">正常情况</figcaption>
</figure>
<h2><span id="其他配置">其他配置</span></h2>
<h3><span id="启用drm-modeset">启用DRM Modeset</span></h3>
<ol type="1">
<li><p>执行
<code>cat /sys/module/nvidia_drm/parameters/modeset</code>来检查 (DRM)
modesettings 模式是否开启, 我们可以通过开启DRM模式来提升显卡的兼容程度.
如果输出为 <code>"Y"</code>,表示已启用该设置.</p>
<p><em>DRM Modeset具体可以参考</em> - <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager#Overview" class="uri">https://en.wikipedia.org/wiki/Direct_Rendering_Manager#Overview</a>
- <a target="_blank" rel="noopener" href="https://download.nvidia.com/XFree86/Linux-x86_64/460.32.03/README/kms.html" class="uri">https://download.nvidia.com/XFree86/Linux-x86_64/460.32.03/README/kms.html</a></p></li>
<li><p>如果显示为<code>N</code>, 那么下面有两种方式来开启它.</p>
<ul>
<li><p><strong>修改内核命令行</strong> 添加
<code>nvidia_drm.modeset=1</code> 参数,
在<code>/etc/default/grub/</code>中添加<code>GRUB_CMDLINE_LINUX_DEFAULT=</code>字段值为<code>GRUB_CMDLINE_LINUX_DEFAULT="nvidia-drm.modeset=1"</code>.
这其实就是在内核启动时为他添加一个参数. 这个参数的用处很大,
例如启动时输出内核信息的日志等级(loglevel=x),
开机自定义闪屏(splash)等功能也可以从这里传参.</p></li>
<li><p><strong>也通过模块配置传递此参数:</strong></p>
<p>可以将 nvidia_drm.modeset=1 参数通过模块配置文件传递.创建
<code>/etc/modprobe.d/nvidia_drm.conf</code> 文件. 这个配置文件会在加载
nvidia_drm 模块时自动启用.</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> options nvidia_drm modeset=1 | <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/modprobe.d/nvidia_drm.conf<br></code></pre></td></tr></table></figure></p></li>
</ul></li>
<li><p>在此之后还需要更新一下grub和内核.</p>
<ul>
<li><code>sudo update-grub2</code>更新grub.</li>
<li><code>sudo update-initramfs -u</code> 更新内核.</li>
</ul></li>
</ol>
<h3><span id="编写脚本手动设置-nvidia-gpu为默认">编写脚本手动设置 NVIDIA GPU
为默认</span></h3>
<ol type="1">
<li><p>编辑环境变量文件:</p>
<ul>
<li>编辑 <code>~/.bashrc</code> 文件, 添加以下内容.</li>
</ul>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> __NV_PRIME_RENDER_OFFLOAD=1<br><span class="hljs-built_in">export</span> __GLX_VENDOR_LIBRARY_NAME=nvidia<br><span class="hljs-built_in">export</span> __VK_LAYER_NV_optimus=NVIDIA_only<br></code></pre></td></tr></table></figure></p></li>
<li><p><code>source ~/.bashrc</code>应用更改.</p></li>
</ol>
<h2><span id="小结">小结</span></h2>
<ol type="1">
<li>看到一些做法还会禁用原本的 nouveau 驱动(包括<a target="_blank" rel="noopener" href="https://download.nvidia.com/XFree86/Linux-x86/352.79/README/installdriver.html">NVIDIA文档</a>),
不过我并没有发现异常, 因此就没禁用 nouveau. 但还是在这里mark一下,
便于以后岁月史书.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">echo</span> blacklist nouveau &gt; /etc/modprobe.d/blacklist-nvidia-nouveau.conf<br><span class="hljs-built_in">sudo</span> update-initramfs -u<br></code></pre></td></tr></table></figure>
<ol type="1">
<li>关于多显卡的情况, 对于 ubuntu 可以通过 prime-select
来切换显卡(甚至有一个图形界面). 而对于 debian 来说, 并没有这个功能.
但可以通过<a target="_blank" rel="noopener" href="https://github.com/bayasdev/envycontrol">这个项目</a>来进行切换.</li>
</ol>
<h3><span id="废弃的">废弃的</span></h3>
<p>在上面配置完环境变量其实就完完毕了,
其实还有几步后来发现没有用处的操作. 在这里保留一下做备用.</p>
<ol start="3" type="1">
<li><p>编辑 SDDM 配置文件</p>
<ul>
<li><p><code>sudo vim /etc/sddm.conf</code>使用终端打开配置文件.</p></li>
<li><p>如果文件不存在,编辑或者干脆直接创建一个
<code>/etc/sddm.conf.d/default.conf</code>:</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> vim /etc/sddm.conf.d/default.conf<br></code></pre></td></tr></table></figure></p></li>
</ul></li>
<li><p>添加以下内容:</p>
<p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[General]</span><br><span class="hljs-attr">DisplayCommand</span>=/etc/sddm/prime-<span class="hljs-literal">off</span>load.sh<br></code></pre></td></tr></table></figure></p></li>
<li><p>创建 <code>prime-offload.sh</code> 脚本:</p>
<ol type="1">
<li><p><code>xrandr --listproviders</code>查看当前显卡标识, 例如我的就叫
NVIDIA-G0. 这里的名称事实上是驱动名称, 而驱动反映了背后所操控的硬件.
例如 modesetting 驱动一般对应着集显, NVIDIA-G0 驱动显然对应着N卡.</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Providers: number : 2<br>Provider 0: <span class="hljs-built_in">id</span>: 0x45 <span class="hljs-built_in">cap</span>: 0xf, Source Output, Sink Output, Source Offload, Sink Offload crtcs: 4 outputs: 3 associated providers: 1 name:modesetting<br>Provider 1: <span class="hljs-built_in">id</span>: 0x270 <span class="hljs-built_in">cap</span>: 0x2, Sink Output crtcs: 4 outputs: 1 associated providers: 1 name:NVIDIA-G0<br></code></pre></td></tr></table></figure></p></li>
<li><p><code>sudo vim /etc/sddm/prime-offload.sh</code>,
创建并编辑脚本文件, 添加以下内容:</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>xrandr --setprovideroutputsource modesetting &lt;需要强制使用的显卡名称&gt;<br>xrandr --auto<br></code></pre></td></tr></table></figure></p></li>
</ol></li>
<li><p>设置脚本权限:</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chmod</span> +x /etc/sddm/prime-offload.sh<br></code></pre></td></tr></table></figure></p></li>
</ol>

	</article>

	 
  
	<div class="kira-post-nav">
		<nav class="post-nav">
			
		</nav>
	</div>
	
	<div class="kira-post-meta kira-rainbow">
		
		
			<a class="kirafont icon-tag-fill -none-link" href="/tags/Debian/" rel="tag">Debian</a> <a class="kirafont icon-tag-fill -none-link" href="/tags/Linux/" rel="tag">Linux</a> <a class="kirafont icon-tag-fill -none-link" href="/tags/%E7%8E%A9%E7%94%B5%E8%84%91/" rel="tag">玩电脑</a>
		
	</div>
	
	<div class="kira-post-footer">
		

		
	</div>
	
</div>

				</div>
			</div>
			<div class="kira-right-column">
	<a onclick="document.querySelector('#kira-top-header').scrollIntoView({behavior: 'smooth'});" class="kira-backtotop" aria-label="回到顶部" title="回到顶部">
		<button class="mdui-fab mdui-ripple">
			<i class="kirafont icon-caret-up"></i>
		</button>
	</a>
</div>

		</div>
	</body>
</html>
